
---
title: "Correlation between Tracing Analysis anrater_data Human rating"
output: html_rater_dataocument
---

```{r}
library(tidyverse)
library(lme4)
library(groupdata2)
library(dplyr)
library(knitr) # kable()
library(broom) #tidy()
library(hydroGOF) # rmse()
```

### NCC Loss

For a reference anrater_data a rater_datarawing:

1. Multiply the value (0-1) at each pair of corresponrater_dataing pixels anrater_data sum them up

2. Normalize the sum to mean=0, strater_data=1

#### Import rater_data
```{r}
rater_data <- read.csv('kiddraw_tracing_summary.csv')%>%
  mutate(tracing_item = factor(tracing_item, levels = c('square', 'shape', 'circle')))
```

```{r}
for (t in c('square', 'shape')){
  for (i in seq(2, 10, by=1) ){
    sub = subset(rater_data , tracing_item == t & age == i)
    print (c(t, i, nrow(sub)) )
  }
}
```


```{r}
rater_data$overall = -1 * scale(rater_data$overall)

rater_data %>%
  gather(registration, val, human_norm_rating, overall) %>%
  ggplot(aes(x = age, y = val, color = tracing_item)) +
    geom_point() +
    geom_smooth(methorater_data = 'lm') +
    facet_wrap(~ registration) +
    theme_bw() +
    theme(aspect.ratio = 1) 
```

```{r}
rater_data$norm_shape = -1 * scale(rater_data$norm_shape)
rater_data %>%
  gather(registration, val, human_norm_rating, norm_shape) %>%
  ggplot(aes(x = age, y = val, color = tracing_item)) +
    geom_point() +
    geom_smooth(methorater_data = 'lm') +
    facet_wrap(~ registration) +
    theme_bw() +
    theme(aspect.ratio = 1) 
```

```{r}
rater_data$norm_spatial = -1 * scale(rater_data$norm_spatial)
rater_data %>%
  gather(registration, val, human_norm_rating, norm_spatial) %>%
  ggplot(aes(x = age, y = val, color = tracing_item)) +
    geom_point() +
    geom_smooth(methorater_data = 'lm') +
    facet_wrap(~ registration) +
    theme_bw() +
    theme(aspect.ratio = 1) 
```

#### Corrleation of human rating with NCC Loss: 
Shape Error anrater_data Human Rating: r = - 0.77, p < 0.01

Spatial Error anrater_data Human Rating: r = - 0.52, p < 0.01

Shape+Spatial Error anrater_data Human Rating: r = - 0.72, p < 0.01

```{r}
cor.test(rater_data$norm_shape, rater_data$human_norm_rating)
```
```{r}
cor.test(rater_data$norm_spatial, rater_data$human_norm_rating)
```
```{r}
cor.test(rater_data$overall, rater_data$human_norm_rating)
```

#### Linear Model
```{r}
rater_rater_dataata$overall = scale(rater_rater_dataata$overall)
m1 = lmer(human_norm_rating ~ age + norm_shape + norm_spatial + tracing_item + (1 | session_irater_data), rater_dataata=rater_rater_dataata)
summary(m1)
```

#### Cross-Valirater_dataation

```{r}
rater_data <- read.csv('kiddraw_tracing_summary.csv')

train_ind <- sample(1:nrow(rater_data), nrow(rater_data) * 0.8)
train <- rater_data[train_ind, ]
test <- rater_data[-train_ind, -which(names(rater_data)=="human_norm_rating")]
test.Y = rater_data[-train_ind, ]$human_norm_rating
```

```{r}
m1 = lmer(human_norm_rating ~ age + norm_shape + norm_spatial + tracing_item + (1 | session_id), data=train)
m2 = lmer(human_norm_rating ~ age + norm_shape + norm_spatial + (1 | tracing_item ), data=train)
m3 = lmer(human_norm_rating ~ age + norm_shape + norm_spatial + (1 | session_id), data=train)
models = c(m1, m2, m3)

pred1 = predict(m1, newdata = test, allow.new.levels = TRUE)
mse1 = mean((pred1 - test.Y)^2)
pred2 = predict(m2, newdata = test, allow.new.levels = TRUE)
mse2 = mean((pred2 - test.Y)^2)
pred3 = predict(m3, newdata = test, allow.new.levels = TRUE)
mse3 = mean((pred3 - test.Y)^2)

mse_list = c(mse1, mse2, mse3)
mse_list
summary(m1)

```


```{r}


train.rest = train[,-which(names(rater_data)=="human_norm_rating")]
train.Y = train$human_norm_rating

t_pred1 = predict(m1, newdata = train.rest, allow.new.levels = TRUE)
t_mse1 = mean((t_pred1 - train.Y)^2)
t_pred2 = predict(m2, newdata = train.rest, allow.new.levels = TRUE)
t_mse2 = mean((t_pred2 - train.Y)^2)
t_pred3 = predict(m3, newdata = train.rest, allow.new.levels = TRUE)
t_mse3 = mean((t_pred3 - train.Y)^2)
c(t_mse1, t_mse2, t_mse3)
```

```{r}
num_fold = 5

for (t in c('square', 'shape', 'circle')){
  for (i in seq(2, 10, by=1) ){
    sub = subset(rater_data , tracing_item == 'square' & age == i)
    
  }
}
```


```{r}
# Split data in 20/80 (percentage)
set.seed(1)
parts <- partition(rater_data, p = 0.2, cat_col = c("age", "tracing_item"))

test_set <- parts[[1]]
train_set <- parts[[2]]
```

```{r}
set.seed(1)
# Split data in 20/80 (percentage)
train_set <- fold(train_set, k=5, cat_col = c("age", "tracing_item"))

# Order by .folds
train_set <- train_set[order(train_set$.folds),]

train_set %>% 
  count(age, tracing_item, .folds) %>% 
  kable(align='c')

```

```{r}
crossvalidate <- function(data, k, model, dependent, random = FALSE){
  performances <- c()
  for (fold in 1:k){
    testing_set <- data[data$.folds == fold,]
    training_set <- data[data$.folds != fold,]

    if (isTRUE(random)){

      # Train linear mixed effects model on training set
      model <-  lmer(model, training_set, REML=FALSE)

    } else {

      # Train linear model on training set
      model <-  lm(model, training_set)

    }

    ## Test model

    # Predict the dependent variable in the training_set with the trained model
    predicted <- predict(model, testing_set, allow.new.levels=TRUE)
    MSE <- mean((predicted - testing_set[[dependent]])^2)
    
    # Predict the dependent variable in the test_set with the trained model
    predicted_train <- predict(model, training_set, allow.new.levels=TRUE)
    MSE_train <- mean((predicted_train - training_set[[dependent]])^2)
    
    performances[fold] <- MSE
    print (c("training: ", MSE_train, "test: ", MSE))
    
    test_r = (predicted - testing_set[[dependent]])^2
    train_r = (predicted_train - training_set[[dependent]])^2
    hist(test_r, xlim=c(0,4))
    hist(train_r, xlim=c(0,4))
    
  }

  return (performances)

}
```

```{r}
m1 = "human_norm_rating ~ age + norm_shape + norm_spatial + tracing_item + (1 | session_id)"
m1
result = crossvalidate(train_set, k=5, model=m1, dependent='human_norm_rating', random=TRUE)
print ("Average MSE across all folds")
print (mean(result))
print ("-------------------")
```

```{r}
m2 = "human_norm_rating ~ age + norm_shape + norm_spatial + (1 | tracing_item )"
m2
result = crossvalidate(train_set, k=5, model=m2, dependent='human_norm_rating', random=TRUE)
print ("Average MSE across all folds")
print (mean(result))
print ("-------------------")

m3 = "human_norm_rating ~ age + norm_shape + norm_spatial + (1 | session_id)"
m3
result = crossvalidate(train_set, k=5, model=m3, dependent='human_norm_rating', random=TRUE)
print ("Average MSE across all folds")
print (mean(result))
print ("-------------------")
```
```{r}
# Creating the model for the full training set
model_m1 <- lmer(m1, train_set, REML = FALSE)

# Predict the dependent variable in the test_set with the trained model
predicted <- predict(model_m1, test_set, allow.new.levels=TRUE)

# Get the Root Mean Square Error between the predicted and the observed
RMSE <- mean((predicted - test_set[['human_norm_rating']])^2)
RMSE
#> [1] 6.418155
```

